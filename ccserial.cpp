#include "ccserial.h"
#include "ui_ccserial.h"
int n[10];
int Achor1_dis;
int Achor2_dis;
int Achor3_dis;
int Achor4_dis;
//表示两个基站的地址，然后是测量是175cm左右，第二个是97.5cm左右
double a[] = { 1798.0,1737.0,1794.0,1802.0,1798.0,1746.0,1724.0,1759.0,1775.0,1748.0,1767.0,1770.0,1794.0,1753.0,1838.0,1771.0,1746.0,1802.0,1884.0,2119.0,2045.0,2020.0,2010.0,2060.0,2037.0,2031.0,2026.0,2020.0,2023.0,1993.0,1962.0,1974.0,1936.0,1945.0,1905.0,1900.0,1961.0,1933.0,1908.0,1959.0,1969.0,1966.0,1925.0,1945.0,1954.0,1969.0,1946.0,1949.0,1977.0,1973.0,1924.0,1945.0,1949.0,1940.0,1933.0,1936.0,1943.0,1920.0,1925.0,1948.0,1957.0,1927.0,1956.0,1935.0,1952.0,1925.0,1954.0,1922.0,1909.0,1936.0,1937.0,1959.0,1933.0,1954.0,1974.0,1952.0,1935.0,1935.0,1930.0,1929.0,1934.0,1948.0,1929.0,1915.0,1967.0,1943.0,1929.0,1923.0,1936.0,1935.0,1927.0,1941.0,1950.0,1921.0,1901.0,1932.0,1920.0,1909.0,1929.0,1945.0,1967.0,1930.0,1949.0,1957.0,1914.0,1905.0,1945.0,1896.0,1942.0,1898.0,1879.0,1881.0,1902.0,1899.0,2011.0,1979.0,1967.0,1892.0,1898.0,1923.0,1947.0,1969.0,1963.0,1925.0,1891.0,1908.0,1955.0,1927.0,1912.0,1902.0,1906.0,1952.0,1909.0,1912.0,1921.0,1905.0,1937.0,1916.0,1915.0,1910.0,1910.0,1916.0,1916.0,1901.0,1916.0,1914.0,1967.0,1973.0,1967.0,1995.0,1939.0,1940.0,1912.0,1930.0,1905.0,1875.0,1832.0,1847.0,1893.0,1932.0,1911.0,1905.0,1969.0,1979.0,1982.0,2020.0,1987.0,2048.0,2009.0,2018.0,2000.0,2031.0,2037.0,2051.0,2022.0,2024.0,2029.0,2011.0,2074.0,2078.0,2084.0,2055.0,2023.0,1942.0,1887.0,1846.0,1821.0,1837.0,1845.0,1887.0,1903.0,1909.0,1896.0,1907.0,1930.0,1930.0,1948.0,1914.0,1935.0,1955.0,1930.0,1966.0,1916.0,1923.0,1846.0,1817.0,1819.0,1840.0,1884.0,1911.0,1960.0,1938.0,1932.0,1926.0,1914.0,1914.0,1929.0,1918.0,1919.0,1898.0,1920.0,1901.0,1919.0,1915.0,1908.0,1880.0,1864.0,1879.0,1896.0,1879.0,1891.0,1911.0,1915.0,1889.0,1879.0,1914.0,1912.0,1886.0,1976.0,1934.0,1914.0,1922.0,1938.0,1935.0,1912.0,1888.0,1975.0,1861.0,1881.0,1879.0,1844.0,1878.0,1889.0,1901.0,1911.0,1954.0,1982.0,1945.0,1920.0,1926.0,1908.0,1911.0,1976.0,2007.0,1979.0,1994.0,2001.0,1975.0,1964.0,1928.0,1928.0,1929.0,1889.0,1884.0,1932.0,1916.0,1908.0,1911.0,1927.0,1884.0,1919.0,1915.0,1943.0,1880.0,1894.0,1882.0,1833.0,1886.0,1858.0,1889.0,1887.0,1867.0,1866.0,1852.0,1828.0,1838.0,1834.0,1780.0,1784.0,1777.0,1753.0,1766.0,1793.0,1777.0,1887.0,1886.0,1881.0,1911.0,1886.0,1869.0,1860.0,1797.0,1825.0,1842.0,1820.0,1833.0,1839.0,1777.0,1782.0,1730.0,1806.0,1792.0,1779.0,1809.0,1811.0,1773.0,1923.0,1944.0,2326.0,2050.0,2057.0,1854.0,1690.0,2333.0,2264.0,1862.0,1790.0,1744.0,1791.0,1738.0,1934.0,1764.0,1760.0,1947.0,2147.0,1869.0,1841.0,1820.0,1974.0,2256.0,2185.0,2049.0,2067.0,1986.0,1966.0,1926.0,1913.0,1909.0,1862.0,1881.0,1839.0,1853.0,1894.0,1833.0,1873.0,1901.0,1913.0,1907.0,1895.0,1895.0,1875.0,1887.0,1889.0,1885.0,1873.0,1860.0,1875.0,1907.0,1892.0,1898.0,1886.0,1848.0,1887.0,1887.0,1871.0,1888.0,1922.0,1949.0,1970.0,1919.0,1946.0,1879.0,1853.0,1894.0,1939.0,1957.0,1946.0,1993.0,1980.0,1925.0,1929.0,1882.0,1876.0,1868.0,1850.0,1849.0,1852.0,1864.0,1853.0,1821.0,1878.0,1888.0,1875.0,1907.0,1900.0,1880.0,1888.0,1880.0,1886.0,1905.0,1876.0,1920.0,1921.0,1918.0,1923.0,1922.0,1935.0,1926.0,1925.0,1884.0,1936.0,1919.0,1935.0,1950.0,1927.0,1959.0,1949.0,1945.0,1934.0,1907.0,1925.0,1929.0,1927.0,1926.0,1894.0,1945.0,1953.0,1940.0,1887.0,1907.0,1886.0,1922.0,1909.0,1946.0,1905.0,1955.0,1970.0,1961.0,1950.0,1895.0,1898.0,1905.0,1873.0,1866.0,1847.0,1885.0,1869.0,1880.0,1869.0,1881.0,1905.0,1865.0,1887.0,1880.0,1869.0,1919.0,1901.0,1903.0,1919.0,1906.0,1964.0,1963.0,1918.0,1949.0,1899.0,1933.0,1961.0,1960.0,1979.0 };
double b[]={909.000000,878.500000,907.000000,911.000000,909.000000,883.000000,872.000000,889.500000,897.500000,884.000000,893.500000,895.000000,907.000000,886.500000,929.000000,895.500000,883.000000,911.000000,952.000000,1069.500000,1032.500000,1020.000000,1015.000000,1040.000000,1028.500000,1025.500000,1023.000000,1020.000000,1021.500000,1006.500000,991.000000,997.000000,978.000000,982.500000,962.500000,960.000000,990.500000,976.500000,964.000000,989.500000,994.500000,993.000000,972.500000,982.500000,987.000000,994.500000,983.000000,984.500000,998.500000,996.500000,972.000000,982.500000,984.500000,980.000000,976.500000,978.000000,981.500000,970.000000,972.500000,984.000000,988.500000,973.500000,988.000000,977.500000,986.000000,972.500000,987.000000,971.000000,964.500000,978.000000,978.500000,989.500000,976.500000,987.000000,997.000000,986.000000,977.500000,977.500000,975.000000,974.500000,977.000000,984.000000,974.500000,967.500000,993.500000,981.500000,974.500000,971.500000,978.000000,977.500000,973.500000,980.500000,985.000000,970.500000,960.500000,976.000000,970.000000,964.500000,974.500000,982.500000,993.500000,975.000000,984.500000,988.500000,967.000000,962.500000,982.500000,958.000000,981.000000,959.000000,949.500000,950.500000,961.000000,959.500000,1015.500000,999.500000,993.500000,956.000000,959.000000,971.500000,983.500000,994.500000,991.500000,972.500000,955.500000,964.000000,987.500000,973.500000,966.000000,961.000000,963.000000,986.000000,964.500000,966.000000,970.500000,962.500000,978.500000,968.000000,967.500000,965.000000,965.000000,968.000000,968.000000,960.500000,968.000000,967.000000,993.500000,996.500000,993.500000,1007.500000,979.500000,980.000000,966.000000,975.000000,962.500000,947.500000,926.000000,933.500000,956.500000,976.000000,965.500000,962.500000,994.500000,999.500000,1001.000000,1020.000000,1003.500000,1034.000000,1014.500000,1019.000000,1010.000000,1025.500000,1028.500000,1035.500000,1021.000000,1022.000000,1024.500000,1015.500000,1047.000000,1049.000000,1052.000000,1037.500000,1021.500000,981.000000,953.500000,933.000000,920.500000,928.500000,932.500000,953.500000,961.500000,964.500000,958.000000,963.500000,975.000000,975.000000,984.000000,967.000000,977.500000,987.500000,975.000000,993.000000,968.000000,971.500000,933.000000,918.500000,919.500000,930.000000,952.000000,965.500000,990.000000,979.000000,976.000000,973.000000,967.000000,967.000000,974.500000,969.000000,969.500000,959.000000,970.000000,960.500000,969.500000,967.500000,964.000000,950.000000,942.000000,949.500000,958.000000,949.500000,955.500000,965.500000,967.500000,954.500000,949.500000,967.000000,966.000000,953.000000,998.000000,977.000000,967.000000,971.000000,979.000000,977.500000,966.000000,954.000000,997.500000,940.500000,950.500000,949.500000,932.000000,949.000000,954.500000,960.500000,965.500000,987.000000,1001.000000,982.500000,970.000000,973.000000,964.000000,965.500000,998.000000,1013.500000,999.500000,1007.000000,1010.500000,997.500000,992.000000,974.000000,974.000000,974.500000,954.500000,952.000000,976.000000,968.000000,964.000000,965.500000,973.500000,952.000000,969.500000,967.500000,981.500000,950.000000,957.000000,951.000000,926.500000,953.000000,939.000000,954.500000,953.500000,943.500000,943.000000,936.000000,924.000000,929.000000,927.000000,900.000000,902.000000,898.500000,886.500000,893.000000,906.500000,898.500000,953.500000,953.000000,950.500000,965.500000,953.000000,944.500000,940.000000,908.500000,922.500000,931.000000,920.000000,926.500000,929.500000,898.500000,901.000000,875.000000,913.000000,906.000000,899.500000,914.500000,915.500000,896.500000,971.500000,982.000000,1173.000000,1035.000000,1038.500000,937.000000,855.000000,1176.500000,1142.000000,941.000000,905.000000,882.000000,905.500000,879.000000,977.000000,892.000000,890.000000,983.500000,1083.500000,944.500000,930.500000,920.000000,997.000000,1138.000000,1102.500000,1034.500000,1043.500000,1003.000000,993.000000,973.000000,966.500000,964.500000,941.000000,950.500000,929.500000,936.500000,957.000000,926.500000,946.500000,960.500000,966.500000,963.500000,957.500000,957.500000,947.500000,953.500000,954.500000,952.500000,946.500000,940.000000,947.500000,963.500000,956.000000,959.000000,953.000000,934.000000,953.500000,953.500000,945.500000,954.000000,971.000000,984.500000,995.000000,969.500000,983.000000,949.500000,936.500000,957.000000,979.500000,988.500000,983.000000,1006.500000,1000.000000,972.500000,974.500000,951.000000,948.000000,944.000000,935.000000,934.500000,936.000000,942.000000,936.500000,920.500000,949.000000,954.000000,947.500000,963.500000,960.000000,950.000000,954.000000,950.000000,953.000000,962.500000,948.000000,970.000000,970.500000,969.000000,971.500000,971.000000,977.500000,973.000000,972.500000,952.000000,978.000000,969.500000,977.500000,985.000000,973.500000,989.500000,984.500000,982.500000,977.000000,963.500000,972.500000,974.500000,973.500000,973.000000,957.000000,982.500000,986.500000,980.000000,953.500000,963.500000,953.000000,971.000000,964.500000,983.000000,962.500000,987.500000,995.000000,990.500000,985.000000,957.500000,959.000000,962.500000,946.500000,943.000000,933.500000,952.500000,944.500000,950.000000,944.500000,950.500000,962.500000,942.500000,953.500000,950.000000,944.500000,969.500000,960.500000,961.500000,969.500000,963.000000,992.000000,991.500000,969.000000,984.500000,959.500000,976.500000,990.500000,990.000000,999.500000};
int length=sizeof(a)/sizeof(a[0]);
//debugok
const double C = 299792458.0;       // Speed of light
const double tsfreq = 499.2e6 * 128;  // Timestamp counter frequency）

QByteArray Anchorsraw[4][4];

QByteArray Anchortdoa[2][6];


qlonglong Anchortdoaint[6][6];
double flytime;
int Anchors[4][4];
int Anchorsdis[4]={0,0,0,0};

QString tagname;
double td1,td2,ty1,ty2;
int tagnumber;
//end

bool calok = 0;
bool debugok = 0;
bool tdoatest = 1;
//need to be declared in the outside!!!!!!!!!当我没说
bool Anchors_4;
bool Anchors_3;


CCserial::CCserial(QWidget *parent) :
    QDialog(parent),
    ui(new Ui::CCserial)
{
    ui->setupUi(this);
    //开启显示串口数据
    showok = 1;
    //查找可用的串口，返回了一份可用串口的列表（函数return）
    foreach(const QSerialPortInfo &info, QSerialPortInfo::availablePorts())
    {
        QSerialPort serial;

        //QString sttr=QSerialPortInfo::availablePorts();

        serial.setPort(info);

        // qDebug() <<  serial.portName();

        if(serial.open(QIODevice::ReadWrite))
        {
            ui->PortBox->addItem(serial.portName());

            serial.close();
        }
        // QObject::connect(ui->mapButton, SIGNAL(clicked()), this,  &CCserial::on_mapButton_clicked());

    }

    // ui->PortBox->addItem("COM15");

    //设置波特率下拉菜单默认显示第二项
    ui->BaudBox->setCurrentIndex(5);
    //关闭发送按钮的使能
    ui->sendButton->setEnabled(false);
    Anchors_3 = 0;
    Anchors_4 = 0;
    qDebug() << "界面设定成功！";

    //定义协议包头
    bagbuff.resize(100); //缓冲区大小
    head.resize(2);
    tail.resize(2);
    head[0] = 0x55;
    head[1] = 0xaa;
    tail[0] = 0x0a;
    tail[1] = 0xdb;
    /*
     * 调试用数据
     */
    Achor1_dis = 120;
    Achor2_dis = 60;
    Achor3_dis = 80;
}

CCserial::~CCserial()
{
    delete ui;
}

//清空接受窗口
void CCserial::on_clearButton_clicked()
{
    ui->textEdit->clear();
}
//发送数据
void CCserial::on_sendButton_clicked()
{
    serial->write(ui->textEdit_2->toPlainText().toLatin1());
}
//读取接收到的数据
void CCserial::Read_Data()
{
    QByteArray buf;
    QByteArray data;

    buf = serial->readAll();
    tempdata = buf;

    //qDebug() << tempdata.toHex()+".......";

    if(Anchors_3)
    {
        if(tempdata.startsWith(head[0]))  //是否是0x55开头
        {
            buffok = 1;

            //bagbuff = tempdata;

        }
        if(buffok)      //缓冲区开启
        {
            bagbuff += tempdata;
        }
        if(bagbuff.endsWith(tail[0]))   //是否结束
        {
            buffok = 0;
            // qDebug() << bagbuff.toHex();


            bagok = 1;
        }
       //这里就是解算数据了，但test中，我们使用的是解析完的数据，也就是这些内容不会被执行
        if(bagok&&calok)
        {
            Achor1 = bagbuff.mid(9,1)+bagbuff.mid(8,1)+bagbuff.mid(7,1)+bagbuff.mid(6,1);
            Achor2 = bagbuff.mid(14,1)+bagbuff.mid(13,1)+bagbuff.mid(12,1)+bagbuff.mid(11,1);
            Achor3 = bagbuff.mid(19,1)+bagbuff.mid(18,1)+bagbuff.mid(17,1)+bagbuff.mid(16,1);

            Achor1_dis = (Achor1.toHex()).toInt(&ok,16);
            Achor2_dis = (Achor2.toHex()).toInt(&ok,16);
            Achor3_dis = (Achor3.toHex()).toInt(&ok,16);
            bagok = 0;
            bagbuff.clear();

        }
    }
    if(Anchors_4)
    {
        if(tempdata.startsWith(head[0]))  //是否是0x55开头
        {
            buffok = 1;


        }
        if(buffok)      //缓冲区开启
        {
            bagbuff += tempdata;
        }
        if(bagbuff.endsWith(tail[0]))   //是否结束
        {
            buffok = 0;
            // qDebug() << bagbuff.toHex();


            bagok = 1;
        }
        if(bagok&&calok)
        {
            Achor1 = bagbuff.mid(9,1)+bagbuff.mid(8,1)+bagbuff.mid(7,1)+bagbuff.mid(6,1);
            Achor2 = bagbuff.mid(14,1)+bagbuff.mid(13,1)+bagbuff.mid(12,1)+bagbuff.mid(11,1);
            Achor3 = bagbuff.mid(19,1)+bagbuff.mid(18,1)+bagbuff.mid(17,1)+bagbuff.mid(16,1);
            Achor4 = bagbuff.mid(24,1)+bagbuff.mid(23,1)+bagbuff.mid(22,1)+bagbuff.mid(21,1);
            qDebug()<< (Achor4.toHex()).toInt(&ok,16);

            Achor1_dis = (Achor1.toHex()).toInt(&ok,16);
            Achor2_dis = (Achor2.toHex()).toInt(&ok,16);
            Achor3_dis = (Achor3.toHex()).toInt(&ok,16);
            Achor4_dis = (Achor4.toHex()).toInt(&ok,16);


            bagok = 0;
            bagbuff.clear();

        }
    }
    if(debugok)
    {
        int lo = 3;
        int nl = 0;
        int ml = 0;
        if(tempdata.startsWith(head[0]))  //是否是0x55开头
        {
            buffok = 1;


        }
        if(buffok)      //缓冲区开启
        {
            bagbuff += tempdata;
        }
        if(bagbuff.endsWith(tail[1]))   //是否结束
        {
            buffok = 0;


            bagok = 1;
        }
        if(bagok)
        {
            tagname = bagbuff.mid(2,1).toHex().toInt(&ok,16)+'0';
            for(nl = 0;nl < 3;nl ++)
            {
                for(ml = 0;ml < 4;ml ++)
                {
                    Anchorsraw[nl][ml] = bagbuff.mid(lo+3,1)+bagbuff.mid(lo+2,1)+bagbuff.mid(lo+1,1)+bagbuff.mid(lo,1);
                    lo += 4;
                    Anchors[nl][ml] = (Anchorsraw[nl][ml].toHex()).toInt(&ok,16);


                }

                if((Anchors[nl][0] + Anchors[nl][2] + Anchors[nl][1] + Anchors[nl][3]) != 0)
                {
                    td1 = Anchors[nl][0];
                    td2 = Anchors[nl][2];
                    ty1 = Anchors[nl][1];
                    ty2 = Anchors[nl][3];
                    Anchorsdis[nl] = 1000.0 * C * ((td1*td2) - (ty1*ty2)) / (td1+td2+ty1+ty2) / tsfreq;
                }
                qDebug() << QString(" 0: %1 1: %2 2: %3").arg(Anchorsdis[0]).arg(Anchorsdis[1]).arg(Anchorsdis[2]);

            }
            bagok = 0;
            tagnumber = tagname.toInt();
            bagbuff.clear();
            //            if(calok)
            //            {
            emit serialok(Anchorsdis,tagnumber,1);
            //                 calok = 0;
            //            }

        }

    }
    if(tdoatest)
    {
        int lo = 3;//数据包指针
        int nl = 0;//数据个数
        int ml = 0;
        if(tempdata.startsWith(head[0]))  //是否是0x55开头
        {
            buffok = 1;

            //bagbuff = tempdata;

        }
        if(buffok)      //缓冲区开启
        {
            bagbuff += tempdata;
        }
        if(bagbuff.endsWith(tail[1]))   //是否结束
        {
            buffok = 0;
            //qDebug() << bagbuff;


            bagok = 1;
        }
        if(bagok)
        {
            tagname = bagbuff.mid(2,1).toHex().toInt(&ok,16)+'0';
            for(nl = 0;nl < 1;nl ++)
            {
                for(ml = 0;ml < 4;ml ++)
                {
                    Anchortdoa[nl][ml] =bagbuff.mid(lo+4,1)+bagbuff.mid(lo+3,1)+bagbuff.mid(lo+2,1)+bagbuff.mid(lo+1,1)+bagbuff.mid(lo,1);
                    lo += 5;
                    //一行数据的int类型
                    Anchortdoaint[nl][ml] = (Anchortdoa[nl][ml].toHex()).toLongLong(&ok,16);



                }


                if((Anchortdoaint[nl][0] + Anchortdoaint[nl][2] + Anchortdoaint[nl][1] + Anchortdoaint[nl][3]) != 0)
                {
                    flytime = Anchortdoaint[nl][1] -( Anchortdoaint[nl][3] - Anchortdoaint[nl][2] + Anchortdoaint[nl][0] + 300 ) ;
                }

                qDebug() << flytime ;
            }
            bagok = 0;
            tagnumber = tagname.toInt();
            bagbuff.clear();

        }

    }

    if(!buf.isEmpty()&&showok)
    {
        QString str = buf;
        qDebug()<<str+"..............";
        ui->textEdit->append(str);
        QStringList strs=str.split(",");
        int i=0;
        foreach(QString s,strs)
        {

            n[i] =s.toInt();
            //qDebug()<<n[i];
            i++;

        }

        transport();
        //之后在这里实现实时传输数据
    }
    buf.clear();
}
void CCserial::on_openButton_clicked()
{
    if(ui->openButton->text()==tr("打开串口"))
    {
        serial = new QSerialPort;
        //设置串口名
        serial->setPortName(ui->PortBox->currentText());
        //打开串口
        serial->open(QIODevice::ReadWrite);
        //设置波特率???
        serial->setBaudRate(ui->BaudBox->currentText().toInt());
        //设置数据位数
        serial->setDataBits(QSerialPort::Data8);
        serial->setParity(QSerialPort::NoParity);
        serial->setStopBits(QSerialPort::OneStop);

        //设置流控制
        serial->setFlowControl(QSerialPort::NoFlowControl);
        //关闭设置菜单使能
        ui->PortBox->setEnabled(false);
        ui->BaudBox->setEnabled(false);
        ui->openButton->setText(tr("关闭串口"));
        ui->sendButton->setEnabled(true);
        //连接信号槽
        QObject::connect(serial, &QSerialPort::readyRead, this, &CCserial::Read_Data);
        //connect(serial,SIGNAL(readyRead()),this,SLOT(Read_Data()));
    }
    else
    {
        //关闭串口
        serial->clear();
        serial->close();
        serial->deleteLater();
        //恢复设置使能
        ui->PortBox->setEnabled(true);
        ui->BaudBox->setEnabled(true);
        ui->openButton->setText(tr("打开串口"));
        ui->sendButton->setEnabled(false);
    }
}


void CCserial::transport(){
    //想法是实现每10个数据传输一次，大概是0.5s确定一个定位
    KalmanInfo *data = new KalmanInfo;
    Init_KalmanInfo(data, 1.0, 1000.0);
    int sum1=0;
    int sum2=0;
    for (int i = 0; i < length; i++){
        sum1+=a[i];
        sum2+=b[i];
    }
    float Anchor1=sum1/length;
    float Anchor2=sum2/length;
    emit sendData(Anchor1,Anchor2);
}

void CCserial::on_debug_clicked()
{
transport();
}
